sap.ui.define(["zretail_sfl/controller/BaseController","sap/ui/model/odata/v2/ODataModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/Text","sap/ui/model/json/JSONModel"],function(e,t,r,o,a,n,s,i,l,d,c){"use strict";return e.extend("zretail_sfl.fragments.OrderUpload",{onInit:function(){debugger;this._localModel=this.getOwnerComponent().getModel("local");this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this)},formatDateToISO:function(e){var t=new Date(e);var r=t.getFullYear();var o=String(t.getMonth()+1).padStart(2,"0");var a=String(t.getDate()).padStart(2,"0");var n=String(t.getHours()).padStart(2,"0");var s=String(t.getMinutes()).padStart(2,"0");var i=String(t.getSeconds()).padStart(2,"0");return`${r}-${o}-${a}T${n}:${s}:${i}`},onBeforeRendering:function(){debugger;if(this.oRouter){this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){debugger;this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(){debugger;this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this);var e="zretail_sfl.fragments.front";var t="zretail_sfl.fragments.front";var r=this.getView();var o=r.getController();o.loadFragment(e,t)},onFileChange:function(e){var t=e.getParameter("files");var o=this.byId("btnRemove");if(t&&t.length>0){this._file=t[0]}else{r.show("No file selected.")}},onUploadPress:function(){debugger;var e=this._sFragmentUniqueId;var t=this.getView().byId(e+"--errorTableContainer");t.destroyItems();var a=this.getView().byId(e+"--errorDownloadContainer");a.destroyItems();if(!this._file){r.show("Please select a file first.");return}var n=new FileReader;var s=this;n.onload=function(e){var t=new Uint8Array(e.target.result);var r=XLSX.read(t,{type:"array"});var a=r.SheetNames[0];var n=r.Sheets[a];var i=XLSX.utils.sheet_to_json(n,{header:1});var l=s._validateHeaders(i[0]);debugger;if(l!=="OrderUpload"){o.error("Invalid file format. Please upload a correct file.");return}s._sendDataToOData(i);s._resetFileUploader()};n.readAsArrayBuffer(this._file)},_validateHeaders:function(e){var t=["DOCTYPE","SALES ORG","DIST CH","DIVN","SOLD TO","SHIP TO","PO REF","PO DATE(DD.MM.YYYY)","PARTNO","DELY QTY"];var r=["Customer Code","Invoice No","GRN No","GRN Date"];var o=["Plant","Material","Quantity","Remarks"];debugger;if(this._compareHeaders(e,t)){return"OrderUpload"}else if(this._compareHeaders(e,r)){return"GRNUpload"}else if(this._compareHeaders(e,o)){return"StockUpload"}},_resetFileUploader:function(){this._file=null;var e=this.getView().byId(this._sFragmentUniqueId+"--myFileUploadORD");if(e){e.setValue("")}},_compareHeaders:function(e,t){var r=new Set(e.map(e=>e.trim().toLowerCase()));return t.every(e=>r.has(e.trim().toLowerCase()))},_sendDataToOData:async function(e){console.log("data:",e);debugger;var o=new t("/sap/opu/odata/sap/YSD_RETAIL_SO_SRV/",{json:true,useBatch:false});var a=["Doctype","Salesorg","Distch","Divn","Soldto","Shipto","Poref","Podate","Partno","Delyqty"];var n=e.map(function(e){var t={};a.forEach(function(r,o){if(e[o]!==undefined&&e[o]!==null&&e[o]!==""){if(r==="Delyqty"){t[r]=parseInt(e[o].replace(/,/g,""),10)}else if(r==="Podate"){t[r]=e[o]}else{t[r]=String(e[o])}}});return t});n=n.slice(1);var s=JSON.stringify(n,null,2);var i=btoa(encodeURIComponent(s));let l={};let d={};const c=JSON.parse(localStorage.getItem("divisionData"))||{};const u=c.selectedDivision||null;const p=c.selectedSflTile||false;const g=c.selectedTplTile||false;let h=null;let m=null;if(u){m=u}if(p){h="5010"}else if(g){h="6400"}var f=localStorage.getItem("userInfo");var v=JSON.parse(f);const w=v.email;l.Key="X";l.Value=i;l.Bukrs=h;l.Spart=m;l.Upload="ORDER";l.Email=w;d.Value=i;d.Bukrs=h;d.Spart=m;d.Email=w;d.Upload="ORDER";d.Key="X";debugger;try{await this.validateUploadedData(e,h,m,d);r.show("Validation successful. Proceeding with further processing...")}catch(e){debugger;console.error("Validation failed:",e);sap.m.MessageBox.error("Validation failed. Please check the uploaded data.");return}debugger;o.create("/ysd_retail_sojSet",l,{method:"POST",success:function(){sap.m.MessageBox.success("Uploaded successfully.")},error:function(e){console.error("Error uploading entry:",e);sap.m.MessageBox.error("Upload Failed")}})},onDownloadTemplate:async function(){sap.ui.core.BusyIndicator.show();try{const e=await $.ajax({url:"/nodeapp/OU_downloadTemplate",method:"GET",contentType:"application/json",xhrFields:{responseType:"blob"}});sap.ui.core.BusyIndicator.hide();debugger;const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const r=window.URL.createObjectURL(t);const o=document.createElement("a");o.href=r;o.download="OrderTemplate.xlsx";document.body.appendChild(o);o.click();document.body.removeChild(o);window.URL.revokeObjectURL(r)}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error downloading Template:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},validateUploadedData:async function(e,o,a,n){debugger;var s=new t("/sap/opu/odata/sap/YSD_RETAIL_SO_SRV/",{json:true,useBatch:false});return new Promise((e,t)=>{s.create("/ValidationSet",n,{method:"POST",success:(o,a)=>{debugger;const n=a.data.Value;let s=[];if(n){const e=decodeURIComponent(atob(n));const r=JSON.parse(e);t(a);s=r;var i=this._sFragmentUniqueId;var l=this.getView().byId(i+"--errorDownloadContainer");l.destroyItems()}debugger;if(s.length>0){var d=this.getView();var c=d.getController();const e=new sap.m.Link({text:"Download Errors",press:function(){this.onErrorDownload(s)}.bind(this)});e.setTooltip("Click to download the error details");e.addStyleClass("redLink");l.addItem(e);const t=new sap.m.Table({columns:Object.keys(s[0]).map(e=>new sap.m.Column({header:new sap.m.Text({text:e})}))});var u=new sap.ui.model.json.JSONModel(s);const r=new sap.m.ColumnListItem({cells:Object.keys(s[0]).map(e=>new sap.m.Text({text:`{${e}}`}))});t.setModel(u);t.bindItems("/",r);var p=this.getView().byId(i+"--errorTableContainer");p.destroyItems();p.addItem(t)}else{e(a);r.show("Entry Validated successfully-No Errors")}},error:function(e){debugger;t(e);console.error("Error uploading entry:",e);r.show("Error uploading entry")}})})},onErrorDownload:function(e){debugger;sap.ui.core.BusyIndicator.show();try{$.ajax({url:"/nodeapp/OU_downloadError",method:"POST",contentType:"application/json",data:JSON.stringify({errors:e}),xhrFields:{responseType:"blob"},success:e=>{debugger;const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const r=window.URL.createObjectURL(t);const o=document.createElement("a");o.href=r;o.download="OrderUploadErrors.xlsx";document.body.appendChild(o);o.click();document.body.removeChild(o);window.URL.revokeObjectURL(r)},error:e=>{debugger;console.error("Error downloading the file:",e);sap.m.MessageBox.error("Failed to download error file. Please try again.")},complete:()=>{sap.ui.core.BusyIndicator.hide()}})}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error downloading errors:",e);sap.m.MessageBox.error("Failed to download error file. Please try again.")}}})});
//# sourceMappingURL=OrderUpload.js.map