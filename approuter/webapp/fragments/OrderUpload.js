sap.ui.define(["zretail_sfl/controller/BaseController","sap/ui/model/odata/v2/ODataModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/Text","sap/ui/model/json/JSONModel"],function(e,t,r,a,o,s,n,i,l,d,c){"use strict";return e.extend("zretail_sfl.fragments.OrderUpload",{onInit:function(){debugger;this._localModel=this.getOwnerComponent().getModel("local");this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this)},formatDateToISO:function(e){var t=new Date(e);var r=t.getFullYear();var a=String(t.getMonth()+1).padStart(2,"0");var o=String(t.getDate()).padStart(2,"0");var s=String(t.getHours()).padStart(2,"0");var n=String(t.getMinutes()).padStart(2,"0");var i=String(t.getSeconds()).padStart(2,"0");return`${r}-${a}-${o}T${s}:${n}:${i}`},onBeforeRendering:function(){debugger;if(this.oRouter){this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){debugger;this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(){debugger;this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this);var e="zretail_sfl.fragments.front";var t="zretail_sfl.fragments.front";var r=this.getView();var a=r.getController();a.loadFragment(e,t)},onFileChange:function(e){var t=e.getParameter("files");var a=this.byId("btnRemove");if(t&&t.length>0){this._file=t[0]}else{r.show("No file selected.")}},onUploadPress:function(){debugger;var e=this._sFragmentUniqueId;var t=this.getView().byId(e+"--errorTableContainer");t.destroyItems();var o=this.getView().byId(e+"--errorDownloadContainer");o.destroyItems();if(!this._file){r.show("Please select a file first.");return}var s=new FileReader;var n=this._file.name.split(".").pop().toLowerCase();var i=this;var l=this._file.type;s.onload=function(e){var t=e.target.result;var r;try{if(n==="xls"){var o="";var s=new Uint8Array(t);for(var l=0;l<s.byteLength;l++){o+=String.fromCharCode(s[l])}r=XLSX.read(o,{type:"binary"})}else if(n==="xlsx"){r=XLSX.read(new Uint8Array(t),{type:"array"})}else{sap.m.MessageToast.show("Invalid file format.");return}var d=r.Sheets[r.SheetNames[0]];var c=XLSX.utils.sheet_to_json(d,{header:1});console.log(c);var u=i._validateHeaders(c[0]);debugger;if(u!=="OrderUpload"){a.error("Invalid file format. Please upload a correct file.");return}i._sendDataToOData(c);i._resetFileUploader()}catch(e){console.error("Error reading file:",e);sap.m.MessageToast.show("Error reading file: "+e.message)}};s.readAsArrayBuffer(this._file)},_validateHeaders:function(e){var t=["DOCTYPE","SALES ORG","DIST CH","DIVN","SOLD TO","SHIP TO","PO REF","PO DATE(DD.MM.YYYY)","PARTNO","DELY QTY"];var r=["Customer Code","Invoice No","GRN No","GRN Date"];var a=["Plant","Material","Quantity","Remarks"];debugger;if(this._compareHeaders(e,t)){return"OrderUpload"}else if(this._compareHeaders(e,r)){return"GRNUpload"}else if(this._compareHeaders(e,a)){return"StockUpload"}},_resetFileUploader:function(){this._file=null;var e=this.getView().byId(this._sFragmentUniqueId+"--myFileUploadORD");if(e){e.setValue("")}},_compareHeaders:function(e,t){var r=new Set(e.map(e=>e.trim().toLowerCase()));return t.every(e=>r.has(e.trim().toLowerCase()))},_sendDataToOData:async function(e){console.log("data:",e);debugger;var a=new t("/sap/opu/odata/sap/YSD_RETAIL_SO_SRV/",{json:true,useBatch:false});var o=["Doctype","Salesorg","Distch","Divn","Soldto","Shipto","Poref","Podate","Partno","Delyqty"];var s=e.map(function(e){var t={};o.forEach(function(r,a){if(e[a]!==undefined&&e[a]!==null&&e[a]!==""){if(r==="Delyqty"){t[r]=parseInt(e[a].replace(/,/g,""),10)}else if(r==="Podate"){t[r]=e[a]}else{t[r]=String(e[a])}}});return t});s=s.slice(1);var n=JSON.stringify(s,null,2);var i=btoa(encodeURIComponent(n));let l={};let d={};var c=this._localModel.getProperty("/UploadData");const u=JSON.parse(localStorage.getItem("divisionData"))||{};const p=u.selectedDivision||null;const g=u.selectedSflTile||false;const h=u.selectedTplTile||false;let f=null;let m=null;if(p){m=p}if(g){f="5010"}else if(h){f="6400"}var y=localStorage.getItem("userInfo");var v=JSON.parse(y);const w=v.email;l.Key="X";l.Value=i;l.Bukrs=f;l.Spart=m;l.Upload="ORDER";l.Email=w;c.Key="X";c.Value=i;c.Bukrs=f;c.Spart=m;c.Upload="ORDER";c.Email=w;d.Value=i;d.Bukrs=f;d.Spart=m;d.Email=w;d.Upload="ORDER";d.Key="X";debugger;try{await this.validateUploadedData(e,f,m,d);r.show("Validation successful. Proceeding with further processing...")}catch(e){debugger;console.error("Validation failed:",e);sap.m.MessageBox.error("Validation failed. Please check the uploaded data.");return}debugger;this._saveOrderUpload(c)},_saveOrderUpload:async function(e){debugger;sap.ui.core.BusyIndicator.show();$.ajax({url:"/nodeapp/SaveOrder",type:"POST",contentType:"application/json; charset=UTF-8",data:JSON.stringify(e),headers:{"Content-Type":"application/json"},success:async function(e){debugger;sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.success("Uploaded successfully.")}.bind(this),error:function(e){debugger;sap.ui.core.BusyIndicator.hide();var t=e.status;var r=e.statusText;var o=e.responseText;a.error("Upload Failed"+"Status: "+t+" ("+r+")\n"+"Details: "+o)}.bind(this)})},onDownloadTemplate:async function(){sap.ui.core.BusyIndicator.show();try{const e=await $.ajax({url:"/nodeapp/OU_downloadTemplate",method:"GET",contentType:"application/json",xhrFields:{responseType:"blob"}});sap.ui.core.BusyIndicator.hide();debugger;const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const r=window.URL.createObjectURL(t);const a=document.createElement("a");a.href=r;a.download="OrderTemplate.xlsx";document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(r)}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error downloading Template:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},validateUploadedData:async function(e,a,o,s){debugger;var n=new t("/sap/opu/odata/sap/YSD_RETAIL_SO_SRV/",{json:true,useBatch:false});return new Promise((e,t)=>{n.create("/ValidationSet",s,{method:"POST",success:(a,o)=>{debugger;const s=o.data.Value;let n=[];if(s){const e=decodeURIComponent(atob(s));const r=JSON.parse(e);t(o);n=r;var i=this._sFragmentUniqueId;var l=this.getView().byId(i+"--errorDownloadContainer");l.destroyItems()}debugger;if(n.length>0){var d=this.getView();var c=d.getController();const e=new sap.m.Link({text:"Download Errors",press:function(){this.onErrorDownload(n)}.bind(this)});e.setTooltip("Click to download the error details");e.addStyleClass("redLink");l.addItem(e);const t=new sap.m.Table({columns:Object.keys(n[0]).map(e=>new sap.m.Column({header:new sap.m.Text({text:e})}))});var u=new sap.ui.model.json.JSONModel(n);const r=new sap.m.ColumnListItem({cells:Object.keys(n[0]).map(e=>new sap.m.Text({text:`{${e}}`}))});t.setModel(u);t.bindItems("/",r);var p=this.getView().byId(i+"--errorTableContainer");p.destroyItems();p.addItem(t)}else{e(o);r.show("Entry Validated successfully-No Errors")}},error:function(e){debugger;t(e);console.error("Error uploading entry:",e);r.show("Error uploading entry")}})})},onErrorDownload:function(e){debugger;sap.ui.core.BusyIndicator.show();try{$.ajax({url:"/nodeapp/OU_downloadError",method:"POST",contentType:"application/json",data:JSON.stringify({errors:e}),xhrFields:{responseType:"blob"},success:e=>{debugger;const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const r=window.URL.createObjectURL(t);const a=document.createElement("a");a.href=r;a.download="OrderUploadErrors.xlsx";document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(r)},error:e=>{debugger;console.error("Error downloading the file:",e);sap.m.MessageBox.error("Failed to download error file. Please try again.")},complete:()=>{sap.ui.core.BusyIndicator.hide()}})}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Error downloading errors:",e);sap.m.MessageBox.error("Failed to download error file. Please try again.")}}})});
//# sourceMappingURL=OrderUpload.js.map