sap.ui.define(["zretail_sfl/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","zretail_sfl/formatter/formatter"],function(e,t,r,a){"use strict";return e.extend("zretail_sfl.controller.StkRep",{formatter:a,onInit:function(){debugger;this._localModel=this.getOwnerComponent().getModel("mainService");this._readData()},onFragmentLoaded:function(e){debugger;this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this);this._localModel=this.getOwnerComponent().getModel("mainService");this._readData()},onBeforeRendering:function(){debugger;if(this.oRouter){this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){debugger;this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(){debugger;this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this);var e="zretail_sfl.fragments.front";var t="zretail_sfl.fragments.front";var r=this.getView();var a=r.getController();a.loadFragment(e,t)},_readData:async function(){debugger;this._userModel=this.getOwnerComponent().getModel("userModel");let e=localStorage.getItem("userInfo");if(e){let t=JSON.parse(e);this._userModel.setProperty("/",{email:t.email,user:t.user,scopes:t.scopes,given_name:t.user.given_name,family_name:t.user.family_name,user_name:t.user.user_name})}this._userModel=this.getOwnerComponent().getModel("userModel");var t=this._userModel.getProperty("/email");const r=JSON.parse(localStorage.getItem("divisionData"))||{};const a=r.selectedDivision||null;const n=r.selectedSflTile||false;const i=r.selectedTplTile||false;let o=null;let s=null;if(a){s=a}if(n){o="5010"}else if(i){o="6400"}const l={email:t,bukrs:o,spart:s};var d=this.getOwnerComponent().getModel("mainService");d.refreshMetadata();d.refresh(true);var c=this._sFragmentUniqueId;this.getView().byId(c+"--__StkRepTable").setModel(d);var u=this;sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().setModel(d,"mainService");try{const e=await $.ajax({url:"/nodeapp/RetailStklist",method:"GET",contentType:"application/json",data:l});sap.ui.core.BusyIndicator.hide();const t=e;console.log(t);var g=new sap.ui.model.json.JSONModel;g.setData(t);u.getView().setModel(g,"listModel")}catch(e){sap.ui.core.BusyIndicator.hide();var g=new sap.ui.model.json.JSONModel;g.setData([]);u.getView().setModel(g,"listModel");console.error("Error fetching Retail Stock List:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},onWerks:function(e){debugger;this._applyFilters()},onMatnr:function(e){debugger;this._applyFilters()},onMaktx:function(e){debugger;this._applyFilters()},_applyFilters:function(){var e=[];var a=this.byId("searchFieldMatnr").getValue();var n=this.byId("searchFieldMaktx").getValue();var i=this.byId("searchFieldWerks").getValue();if(a){e.push(new t("Matnr",r.Contains,a))}if(i){e.push(new t("Werks",r.Contains,i))}if(n){e.push(new t("Maktx",r.Contains,n))}var o=this.byId("priceTable");var s=o.getBinding("items");if(s){if(e.length>0){if(!Array.isArray(e)){console.error("Filters is not an array:",e);return}var l=new t({filters:e,and:true});s.filter(l)}else{s.filter([])}}},onWerks:function(e){debugger;var a=this._sFragmentUniqueId;var n=e.getParameter("newValue");var i=this.getView().byId(a+"--__StkRepTable");var o=i.getBinding("items");var s=[];if(n&&n.length>0){var l=new t("Werks",r.Contains,n);s.push(new t({filters:[l],and:false}))}o.filter(s)},onMatnr:function(e){debugger;var a=this._sFragmentUniqueId;var n=e.getParameter("newValue");var i=this.getView().byId(a+"--__StkRepTable");var o=i.getBinding("items");var s=[];if(n&&n.length>0){var l=new t("Matnr",r.Contains,n);s.push(new t({filters:[l],and:false}))}o.filter(s)},onDownloadExcel:function(){var e=this.getView().getModel("listModel");var t=e.getProperty("/");if(!t||t.length===0){sap.m.MessageBox.error("No records found to download.");return}var r=t.map(function(e){return{Plant:e.Werks,"Material Number":e.Matnr,"Material Description":e.Maktx,Quantity:e.Fkimg,Remarks:e.Remarks,"Created Date":e.Erdat}});var a=this.convertToCsv(r);var n=new Blob([a],{type:"text/csv;charset=utf-8;"});var i=document.createElement("a");var o=URL.createObjectURL(n);i.setAttribute("href",o);i.setAttribute("download","Stock_data.csv");i.style.visibility="hidden";document.body.appendChild(i);i.click();document.body.removeChild(i)},convertToCsv:function(e){var t="";var r=Object.keys(e[0]);t+=r.join(",")+"\r\n";e.forEach(function(e){t+=r.map(function(t){return e[t]?e[t].toString().replace(/,/g," "):""}).join(",")+"\r\n"});return t}})});
//# sourceMappingURL=StkRep.js.map