sap.ui.define(["zretail_sfl/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","zretail_sfl/formatter/formatter"],function(e,t,r,o){"use strict";return e.extend("zretail_sfl.controller.Price",{formatter:o,onInit:function(){debugger;this._localModel=this.getOwnerComponent().getModel("mainService");this._readData()},onFragmentLoaded:function(e){debugger;const t=JSON.parse(localStorage.getItem("divisionData"))||{};let r=t.selectedDivision||null;let o=new sap.ui.model.json.JSONModel({spart:r});this.getView().setModel(o,"viewModel");this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this);this._localModel=this.getOwnerComponent().getModel("mainService");this._readData()},onBeforeRendering:function(){debugger;if(this.oRouter){this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){debugger;this.oRouter.getRoute("operations").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(){debugger;this.oRouter.getRoute("operations").detachPatternMatched(this._onObjectMatched,this);var e="zretail_sfl.fragments.front";var t="zretail_sfl.fragments.front";var r=this.getView();var o=r.getController();o.loadFragment(e,t)},_readData:async function(){debugger;this._userModel=this.getOwnerComponent().getModel("userModel");let e=localStorage.getItem("userInfo");if(e){let t=JSON.parse(e);this._userModel.setProperty("/",{email:t.email,user:t.user,scopes:t.scopes,given_name:t.user.given_name,family_name:t.user.family_name,user_name:t.user.user_name})}this._userModel=this.getOwnerComponent().getModel("userModel");var t=this._userModel.getProperty("/email");const r=JSON.parse(localStorage.getItem("divisionData"))||{};const o=r.selectedDivision||null;const n=r.selectedSflTile||false;const i=r.selectedTplTile||false;let a=null;let s=null;if(o){s=o}if(n){a="5010"}else if(i){a="6400"}let l=new sap.ui.model.json.JSONModel({spart:s});this.getView().setModel(l,"viewModel");const d={email:t,bukrs:a,spart:s};var c=this.getOwnerComponent().getModel("mainService");c.refreshMetadata();c.refresh(true);var u=this._sFragmentUniqueId;this.getView().byId(u+"--__PriceTable").setModel(c);sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().setModel(c,"mainService");const g=this;sap.ui.core.BusyIndicator.show();try{const e=await $.ajax({url:"/nodeapp/Pricelist",method:"GET",contentType:"application/json",data:d});sap.ui.core.BusyIndicator.hide();const t=e;console.log(t);var h=new sap.ui.model.json.JSONModel;h.setData(t);g.getView().setModel(h,"listModel")}catch(e){sap.ui.core.BusyIndicator.hide();var h=new sap.ui.model.json.JSONModel;h.setData([]);g.getView().setModel(h,"listModel");console.error("Error fetching Price List:",e);const t=e.responseJSON?.error?.innererror?.errordetails?.[0]?.message||"Unknown error occurred"}},onMatnr:function(e){debugger;var o=this._sFragmentUniqueId;var n=e.getParameter("newValue");var i=this.getView().byId(o+"--__PriceTable");var a=i.getBinding("items");var s=[];if(n&&n.length>0){var l=new t("Matnr",r.Contains,n);s.push(new t({filters:[l],and:false}))}a.filter(s)},_applyFilters:function(){var e=[];var o=this.byId("searchFieldMatnr").getValue();if(o){e.push(new t("Matnr",r.Contains,o))}var n=this.byId("priceTable");var i=n.getBinding("items");if(i){if(e.length>0){if(!Array.isArray(e)){console.error("Filters is not an array:",e);return}var a=new t({filters:e,and:true});i.filter(a)}else{i.filter([])}}},onDownloadExcel:function(){var e=this.getView().getModel("listModel");var t=e.getProperty("/");if(!t||t.length===0){sap.m.MessageBox.error("No records found to download.");return}var r=t.map(function(e){return{"Material Number":e.Matnr,Price:e.Kbetr,"Pricing Unit":e.Kpein,UoM:e.Kmein,Currency:e.Konwa}});var o=this.convertToCsv(r);var n=new Blob([o],{type:"text/csv;charset=utf-8;"});var i=document.createElement("a");var a=URL.createObjectURL(n);i.setAttribute("href",a);i.setAttribute("download","PriceList_data.csv");i.style.visibility="hidden";document.body.appendChild(i);i.click();document.body.removeChild(i)},convertToCsv:function(e){var t="";var r=Object.keys(e[0]);t+=r.join(",")+"\r\n";e.forEach(function(e){t+=r.map(function(t){return e[t]?e[t].toString().replace(/,/g," "):""}).join(",")+"\r\n"});return t}})});
//# sourceMappingURL=Price.js.map