sap.ui.define(["zretail_sfl/controller/BaseController","sap/ui/core/Fragment","sap/m/MessageBox"],function(e,t,o){"use strict";return e.extend("zretail_sfl.controller.welcome",{selectedSflTile:false,selectedTplTile:false,onInit:async function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteView1").attachPatternMatched(this._onObjectMatched,this);const e=new Date;const t=new sap.ui.model.json.JSONModel({currentDate:e.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})});this.getView().setModel(t,"dateModel");this._userModel=this.getOwnerComponent().getModel("userModel");let o=this;const s=this;let i=[];let n;try{const e=await fetch("/getUserInformation");const t=await e.json();this._userModel.setProperty("/",{email:t.email,user:t.user,scopes:t.scopes,given_name:t.user.given_name,family_name:t.user.family_name,user_name:t.user.user_name});localStorage.setItem("userInfo",JSON.stringify(t));const o=t.email;n=await $.ajax({url:"/nodeapp/accCont",method:"GET",contentType:"application/json",data:{email:o}});const s=Array.isArray(n)?n[0]:n;if(!s||typeof s!=="object"){throw new Error("Invalid response structure")}localStorage.setItem("accessInfo",JSON.stringify(s));const l=s.Sfl==="X";const a=s.Tpl==="X";if(!l&&!a){sap.m.MessageBox.error("No Company Code Maintained")}const r=this.getOwnerComponent().getModel("tileVisibilityModel");r.setProperty("/showSflTile",l);r.setProperty("/showTplTile",a);this.getView().setModel(r,"tileVisibilityModel");const c=["Autolec","Fd","Rca"];c.forEach(e=>{if(s[e]==="X"){i.push(e)}})}catch(e){console.error("Error fetching AccCont data:",e.message)}console.log("Available Divisions:",i);const l={Autolec:"sap-icon://eam-work-order",Fd:"sap-icon://factory",Mfd:"sap-icon://shipping-status",Rca:"sap-icon://add-product",Ukd:"sap-icon://physical-activity",Ad:"sap-icon://action",Asd:"sap-icon://subway-train",Hwf:"sap-icon://technical-object",Sez:"sap-icon://sales-order"};const a={Autolec:"images/AUTOLEC.jpg",Fd:"images/hightensil.png",Rca:"images/hot_forged.jpg"};const r=this.byId("tileContainer");r.removeAllItems();const c={1:"L12 M12 S12",2:"L6 M6 S12",3:"L4 M6 S12"};const d=c[i.length]||"L4 M6 S12";const u=new sap.ui.layout.Grid({defaultSpan:d,hSpacing:1,vSpacing:1,content:i.map(e=>{const t=e.toUpperCase();const o=a[e]||"images/default-image.png";const s=new sap.m.GenericTile({header:t,systemInfo:t,frameType:"OneByHalf",press:this.onDivisionSelect.bind(this)});s.addStyleClass("transparentTile");s.addDelegate({onAfterRendering:function(){const e=s.getDomRef()}});return s})});r.addItem(u);r.setLayoutData(new sap.ui.layout.GridData({span:"L4 M6 S12"}));r.setJustifyContent(sap.m.FlexJustifyContent.Center);r.setAlignItems(sap.m.FlexAlignItems.Center);sap.ui.core.BusyIndicator.hide();const p=new sap.ui.model.json.JSONModel;p.setData(n);s.getView().setModel(p,"AccContModel");var h=this.byId("_IDGenAvatar");h.addEventDelegate({onmouseover:this.onProfileHover.bind(this),onmouseout:this.onProfileMouseOut.bind(this)})},onBeforeRendering:function(){if(this.oRouter){this.oRouter.getRoute("RouteView1").detachPatternMatched(this._onObjectMatched,this)}},onAfterRendering:function(){this.oRouter.getRoute("RouteView1").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(){debugger;const e=this.getOwnerComponent().getModel("tileSelectedModel");e.setProperty("/selectedTplTile",false);e.setProperty("/selectedSflTile",false);this.oRouter.getRoute("RouteView1").detachPatternMatched(this._onObjectMatched,this)},onDivisionSelect:function(e){debugger;const t=this.getOwnerComponent().getModel("tileSelectedModel");const o=t.getProperty("/selectedSflTile");const s=t.getProperty("/selectedTplTile");if(!o&&!s){sap.m.MessageBox.error("Please select company first and choose division.");return}const i=this.getView().getModel("selectedDivisionModel");i.setProperty("/selectedDivision",e);const n={selectedDivision:e.oSource.mProperties.header,selectedSflTile:o,selectedTplTile:s};localStorage.setItem("divisionData",JSON.stringify(n));this.oRouter.navTo("operations")},onSFLPress:function(){const e=this.getOwnerComponent().getModel("tileSelectedModel");this.selectedSflTile=true;this.selectedTplTile=false;e.setProperty("/selectedSflTile",this.selectedSflTile);e.setProperty("/selectedTplTile",this.selectedTplTile);const t=JSON.parse(localStorage.getItem("divisionData"))||{};t.selectedSflTile=this.selectedSflTile;t.selectedTplTile=this.selectedTplTile;localStorage.setItem("divisionData",JSON.stringify(t))},onTPLPress:function(){const e=this.getOwnerComponent().getModel("tileSelectedModel");this.selectedTplTile=true;this.selectedSflTile=false;e.setProperty("/selectedTplTile",this.selectedTplTile);e.setProperty("/selectedSflTile",this.selectedSflTile);const t=JSON.parse(localStorage.getItem("divisionData"))||{};t.selectedTplTile=this.selectedTplTile;t.selectedSflTile=this.selectedSflTile;localStorage.setItem("divisionData",JSON.stringify(t))},onProfileHover:function(e){debugger;var o=this.getView();var s=e.srcControl;var i=JSON.parse(localStorage.getItem("userInfo"))||{};var n=new sap.ui.model.json.JSONModel(i);if(!this._userdetails){t.load({id:o.getId(),name:"zretail_sfl.fragments.userdetails",controller:this}).then(function(e){o.addDependent(e);this._userdetails=e;this._userdetails.setModel(n,"userModel");this._userdetails.openBy(s)}.bind(this))}else{debugger;this._userdetails.setModel(n,"userModel");this._userdetails.openBy(s)}},_loadUserDetails:function(e){this._userModel=this.getOwnerComponent().getModel("userModel");var t=this._userModel.getProperty("/email")},onProfileMouseOut:function(){if(this._userdetails){this._userdetails.close()}},onLogOut:async function(){debugger;const e=await this.getCsrfToken("/nodeapp/custom/logout");$.ajax({type:"POST",url:"/nodeapp/custom/logout",headers:{"X-CSRF-Token":e,"Content-Type":"application/json"},success:function(e){window.location.href=e},error:function(e,t,o){console.error("Logout failed:",o);console.log("Response status:",e.status);console.log("Response text:",e.responseText)}})},getCsrfToken:function(e){return new Promise(function(t,o){$.ajax({type:"GET",url:e,headers:{"X-CSRF-Token":"fetch","Content-Type":"application/json"},success:function(e,o,s){const i=s.getResponseHeader("X-CSRF-Token");debugger;t(i)},error:function(e,t,s){console.error("Failed to fetch CSRF token:",s);o(s)}})})},startSessionTimeout:function(){const e=48e4;let t;const o=()=>{clearTimeout(t);t=setTimeout(()=>{this.onSessionTimeout()},e)};document.addEventListener("mousemove",o);document.addEventListener("keydown",o);o()},onSessionTimeout:function(){sap.m.MessageToast.show("Session has expired due to inactivity.");this.onLogOut()}})});
//# sourceMappingURL=welcome.controller.js.map